# 核心概念:虚拟化、并发和持久性

## 1 操作系统的基本功能 ##

前面提到过，操作系统的基本作用如下：

* 为用户（应用程序员，实际上是应用程序）提供一个资源集的清晰抽象。
* 管理计算机硬件资源，使其更易于使用。

## 2 操作系统做了什么: 虚拟化、并发和持久性 ##

**OS 取得 CPU、内存或磁盘等物理资源 (resources)，并对它们进行虚拟化(virtualize)。它处理与并发(concurrency)有关的麻烦 且棘手的问题。它持久地(persistently)存储文件，从而使它们长期安全。**

## 3 操作系统设计目标 ##

鉴于我们希望建立以上功能的这样一个系统，所以要有一些目标，以帮助我们集中设计和实现，并在必要时进行折中。找到合适的折中是建立系统的关键。一个最基本的目标，是建立一些**抽象(abstraction) **，让系统方便和易于使用。设计和实现操作系统的另一个目标，是提供**高性能(performance)** 。此外，还有一个目标是在应用程序之间以及在 OS 和应用程序之间提供**保护(protection) **。

## 4 小议贯穿操作系统的三个主题——虚拟化、并发、持久化 ##

**按照操作系统导论(Operating System: Three Easy Pieces)，可以从虚拟化（virtualization）、并发（concurrency）和持久性（persistence）三个方面对操作系统的设计实现进行详细讨论。在每个主题中，针对如何抽象，实现高性能并提供程序之间的保护的讨论都贯穿其中。**

操作系统通过**虚拟化(virtualize)**CPU和内存，使系统更高效且易于使用（允许同时运行多个程序，使用更简单高效的地址空间模型），并且确保了权限的控制 。操作系统处理与**并发(concurrency)**有关的麻烦且棘手的问题。操作系统**持久地(persistently)**存储文件到磁盘等设备，从而使它们能够保证长期安全。

#### 4.1 虚拟化 virtualization ####

操作系统将物理(physical)资源(如处理器、内存或磁盘)转换为更通用、更强大且更易于使用的虚拟形式。操作系统如何将资源虚拟化?这是关键问题。为什么操作系统这样做?这不是主要问题，因为答案应该很明显:它让系统更易于使用。因此，我们关注**如何虚拟化: 操作系统通过哪些机制和策略来实现虚拟化?操作系统如何有效地实现虚拟化?需要哪些硬件支持?**

我们的目标是可控地、高效地虚拟化，CPU 操作系统必须以高性能的方式虚拟化 CPU， 同时保持对系统的控制。 为此， 需要硬件和操作系统支持。操作系统通常会明智地利用硬件支持，以便高效地实现其工作。

###### CPU虚拟化 ######

**虚拟化CPU(virtualizing the CPU)**：在硬件的一些帮助下，操作系统负责提供这种假象(illusion) ，即系统拥有非常多的虚拟 CPU 的假象。将单个 CPU(或其中一小部分)转换为看似无限数量的 CPU， 从而让许多程序看似同时运行， 这就是所谓的虚拟化 CPU (virtualizing the CPU)。

**现代操作系统提供了最基本的抽象——进程/线程**。

操作系统通过**时钟中断触发OS进行上下文切换高效地实现了多个进程同时运行的假象**，同时**通过trap进行系统调用实现了对系统权限的有效控制**。

###### 虚拟化主存 ######

**虚拟化主存(virtualizing memory)**：每个进程访问自己的私有虚拟地址空间(virtual address space) (有时称为地址空间，address space) ， 操作系统以某种方式映射到机器的物理内存上。一个正在运行的程序中的内存引用不会影响其他进程(或操作系统本身)的地址空间。对于正在运行的程序，它完全拥有自己的物理内存。但实际情况是，物理内存是由操作系统管理的共享资源。

**现代操作系统提供了虚拟地址空间抽象。**

操作系统通过虚拟内存系统为程序提供一个巨大的、稀疏的、私有的地址空间的假象，其中保存了程序的所有指令和数据。操作系统在专门硬件的帮助下，通过每一个虚拟内存的索引，将其转换为物理地址，物理内存根据获得的物理地址去获取所需的信息。在这个过程中，操作系统会同时对许多进程执行此操作，操作系统**保证了多个任务方便（透明）并且高效地（尽量减少空间和时间开销）使用内存**，并且**确保程序之间互相不会受到影响，也不会影响操作系统**。

#### 4.2 并发 concurrency ####

**如何构建正确的并发程序**：如果同一个内存空间中有很多并发执行的线程， 如何构建一个正确工作的程序?操作系统需要什么原语?硬件应该提供哪些机制?我们如何利用它们来解决并发问题?

* 并发 (concurrency) ： 我们使用这个术语来指代一系列问题， 这些问题在同时(并发地)处理很多事情时出现且必须解决。并发问题首先出现在操作系统本身中。如你所见，在上面关于虚拟化的例子中，操作系统同时处理很多事情，首先运行一个进程，然后再运行一个进程，等等。并发问题不再局限于操作系统本身。事实上，现代多线程(multi-threaded) 程序也存在相同的问题。

#### 4.3 持久性 persistence ####

**如何持久地存储数据？**文件系统是操作系统的一部分，负责管理持久的数据。持久性需要哪些技术才能正确地实现?需要哪些机制和策略才能高性能地实现?面对硬件和软件故障，可靠性如何实现?

* 持久性(persistence) ：在系统内存中，数据容易丢失，因为像DRAM 这样的设备以易失(volatile)的方式存储数值。如果断电或系统崩溃，那么内存中的所有数据都会丢失。因此，我们需要硬件和软件来持久地(persistently)存储数据。这样的存储对于所有系统都很重要，因为用户非常关心他们的数据。 硬件以某种输入/输出(Input/Output，I/O)设备的形式出现。在现代系统中，硬盘驱动器(hard drive)是存储长期保存的信息的通用存储库，尽管固态硬盘(Solid-State Drive， SSD)正在这个领域取得领先地位。 操作系统中管理磁盘的软件通常称为文件系统 (file system) 。 因此它负责以可靠和高效的方式，将用户创建的任何文件(file)存储在系统的磁盘上。 不像操作系统为 CPU 和内存提供的抽象，操作系统不会为每个应用程序创建专用的虚拟磁盘。相反，它假设用户经常需要共享(share)文件中的信息。

# 输入输出-IO设备

**IO设备一般由机械部件（设备本身）和电子部件两部分组成**，为达到模块化和通用性的设计目标，通常将IO设备的机械部件和电子部件分开处理。其中，电子部件又被称为**设备控制器（device controller）**或**适配器（adapter）**，在某些地方也叫做**IO模块**。

## 1 电子部件-IO模块的功能 ##

IO模块的基本功能是数据缓冲。它还经常负责检错，随后将差错信息报告给处理器。下面是IO模块内外两个层面的连接方式。

1. 通过系统总线或中央交换单元与CPU和主存连接。
2. 通过专用数据线与一个或多个设备相连。

![IO模块通用模型](https://raw.githubusercontent.com/yixy4app/images/picgo/202208272126978.png)

下图用非常通用的术语表示了IO模块的性质。可以看到每个IO模块都有几个寄存器

![IO模块框图](https://raw.githubusercontent.com/yixy4app/images/picgo/202208272127415.jpeg)

下图用非常通用的术语表示了外部设备的性质。

![外部设备通用模型](https://raw.githubusercontent.com/yixy4app/images/picgo/202208272127622.png)

## 2 IO寻址方式 ##

许多IO设备通过IO模块连接到系统，每个设备给出一个唯一标识符或地址。当处理器发送一个IO命令时，该命令包括所需设备地址。因此，每个IO模块必须对地址线译码，确定命令是否发送给自己。

当处理器、主存和IO共享一个公共总线时，可以又两种寻址方式：

**存储映射式寻址（memory-mapped）**：主存单元和IO设备有单一的地址空间，处理器把IO模块的状态，数据寄存器看成存储单元一样对待，并且使用相同机器指令存取主存单元和IO设备。

**分离式寻址（isolated）**：让总线既有存储器读线和写线，也有IO命令线。命令线指定地址是指向主存单元还是指向IO。这样对IO来说，其地址空间与主存是分离的。这种方式下，IO模块上的寄存器也被称为IO端口，CPU通过in/out指令读写端口来进行IO操作。

## 3 基本IO操作技术 ##

基本IO操作技术：

* 编程式IO（programming IO）：在程序的直接、连续控制下发生IO操作。
* 中断式IO（interrupt-driven IO）：程序发出IO命令后继续执行其他指令，直到被IO硬件中断，通知它IO操作完成。
* 存储器直接存取（DMA）：这种情况下一个指定的IO处理器接替两IO操作的控制，在IO设备和存储器之间直接传送大量数据。

**编程式IO**

数据在处理器和IO模块间交换，处理器执行一个使它直接控制IO操作的程序，包括检测设备状态，发送读写命令以及传送数据。当处理器发送一个命令到IO模块时，它必须等待，直到IO操作完成。如果处理器快于IO模块，则处理器的时间就浪费了。

**中断式IO**

当处理器发送了一个IO命令到IO模块后，继续执行其他指令（这里假设有多个程序可以运行）。而当IO模块完成工作准备和处理器交换数据时，就去中断处理器请求服务。然后，处理器执行数据传送，最后再恢复它原来的处理工作。

**DMA**

对于编程式IO和中断式IO，处理器负责在输出时从主存向外界传送数据，输入时在主存中存储数据。而在DMA（direct memory access）模式下，IO模块和主存直接交换数据，不需要处理器参与。

DMA模式在系统总线上新增一个附加模块——DMA模块，它能模仿CPU接管CPU控制系统的任务。为了传送数据给主存或从主存传出，DMA模块需要控制总线。DMA模块只有在CPU不需要总线或强制CPU暂时挂起操作时才能使用总线。DMA模块通过一种周期窃用（cycle-stealing）技术，有效的窃用了一个总线周期，注意，这种情况下CPU不保存现场，也不做其他事，只是等待一个总线周期。

## 4 纳入操作系统：设备驱动程序

每个设备都有非常具体的接口,如何将它们纳入操作系统？注意，我们希望操作系统尽可能通用。例如文件系统,我们希望开发一个文件系统可以工作在SCSI 硬盘、IDE 硬盘、USB 钥匙串设备等设备之上,并且希望这个文件系统不那么清楚对这些不同设备发出读写请求的全部细节。

这个问题可以通过古老的抽象(abstraction)技术来解决。

我们来看看 Linux 文件系统栈,理解抽象技术如何应用于操作系统的设计和实现。图36.3 粗略地展示了 Linux 软件的组织方式。可以看出,文件系统(当然也包括在其之上的应用程序)完全不清楚它使用的是什么类型的磁盘。它只需要简单地向通用块设备层发送读写请求即可,块设备层会将这些请求路由给对应的设备驱动,然后设备驱动来完成真正的底层操作。

## 5IO通道与IO处理机 ##

IO模块在其功能加强后可以成为**IO通道（Channel）**。IO通道带拥有自主权力的处理器，并且有处理IO的特殊指令集。处理器指示IO通道执行存储器中的IO程序。IO通道不需处理器的干预就能获取和执行这些指令。这允许处理器指派一系列IO活动，并只有在整个活动执行完后中断处理器。

**IO处理机**指IO模块拥有自己的处理器和局部存储器，实际上是一台自管辖的计算机。这种结构中，大量IO设备被控制，而处理器参与最少。


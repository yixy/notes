# 可编程寄存器概述

不同的CPU，寄存器的个数、结构是不相同的。

下面主要以8086CPU为例，简单讨论其内部寄存器。

> 80x86是Intel一系列cpu的代称，其中8088,8086，80286为16位cpu，80386为32位寄存器。

8086CPU有14个寄存器（8个通用寄存器，2个专用寄存器，4个段寄存器），它们的长度都是16位，可以存放两个字节。

8086是16位处理器，但是其地址总线长度是20位。所以，8086采用`物理地址=段地址 * 16+偏移地址`的方法用段地址和偏移地址合成物理地址。

Intel x86系列机均为小端存储。

## 0 段寄存器 ##

在冯诺依曼的体系结构中，指令和数据都被放在内存当中。其中指令放在代码段（CS）中，数据放在数据段（DS）中，这样就不会造成混淆。段寄存器专门用于存储器的寻址，在后面的存储器的寻址方式中有非常大的用途，可以用来直接或间接的存放段地址。段寄存器的具体用途会在下面的存储器的寻址方式中讲到。
 
8086CPU有4个段寄存器CS（代码段寄存器）、DS（数据段寄存器）、SS（栈段寄存器）和ES（扩展段寄存器）。

* 代码段寄存器CS
* 数据段寄存器DS
* 堆栈段寄存器SS
* 附加段寄存器ES

**注意，CPU可以用不同的段地址和偏移地址形成同一个物理地址。**

8086CPU中的数据段寄存器DS通常用于存放要访问数据的段地址。

```
mov bx,1000H
mov ds,bx	;8086CPU不支持将数据直接送入段寄存器的操作。
mov al,[0]	;将ds:0的内存单元中的内容送入al寄存器，这里0是偏移地址

mov bx,1000H
mov ds,bx	
mov [0],al	;从寄存器写值到ds:0对应的内存单元，这里0是偏移地址
```

上面程序中`[0]`表示内存单元，其偏移地址是0，默认的段寄存器是ds。但是注意，有些编译器对`[0]`的解释是值0，而不是内存单元。所以，最好是写作`mov al,ds:[0]`，显示给出段地址所在寄存器（即使用段前缀）。或者在`[]`中使用寄存器，间接给出内存单元的偏移地址：`[bx]`也表示一个内存单元，它的偏移地址在bx中。

## 1 通用寄存器 ##

通用寄存器可以用于传送和暂存数据，也可以参与算术运算，并保存运算结果，除此之外不同的通用寄存器有各自特殊的用途。

* 数据寄存器：AX，BX，CX，DX 用来暂时存放计算过程中所用的操作数，结果或其他信息。
* 变址寄存器：SI，DI 用来与段寄存器一起使用进行内存器的变址寻址。
* 指针寄存器：BP，SP 主要用在堆栈中。

8086CPU中，AX、BX、CX、DX这4个寄存器通常用来存放一般性数据，为了兼容上一代8位处理器，均可分为两个8位寄存器使用。

* AX可分为AH和AL
* BX可分为BH和BL
* CX可分为CH和CL
* DX可分为DH和DL

注意，除了通用的用途外，一些寄存器还肩负着特定的作用。比如BX用于内存单元寻址，CX用于循环loop指令的次数控制等。

注意，**在8086CPU中，只有BX、SI、DI、BP 这四个寄存器可以用在[...]中来进行内存单元的寻址。**在[...]中，这4个寄存器可以单独出现，或以4种组合出现：bx和si，bx和di，bp和si，bp和di。注意，只要在[...]中使用寄存器bx，而指令中没有显示给出段前缀，则段地址默认在ds中。只要在[...]中使用寄存器bp，而指令中没有显示给出段前缀，则段地址默认在ss中。

###### 数据寄存器：AX #####

* AX(Accumulator register) ，16位寄存器，可以拆为AH（高8位）和AL（低8位）两个8位寄存器使用。

主要用在：

- [ ] 可以作为累加器
- [ ] 是算术运算的主要寄存器
- [ ] 在乘除运算中用来存放操作数
- [ ] IO指令都使用AX寄存器与外部设备传递信息

###### 数据寄存器：BX #####

* BX(Base register)，16位寄存器，可以拆为BH（高8位）和BL（低8位）两个8位寄存器使用。

在计算存储器的地址时经常用作基址寄存器。可以使用[BX]来进行取地址操作。

###### 数据寄存器：CX #####

* CX(Count register)，16位寄存器，可以拆为CH和BL两个8位寄存器使用。

主要用在：

- [ ] 保存计数值。
- [ ] 保存移位指令，循环指令和串处理指令中作隐含的计数器。

###### 数据寄存器：DX #####

* DX(Data register)， 16位寄存器，可以拆分为DH和DL两个8位寄存器使用。

主要用在：

- [ ] 一般用在字长的扩展当中，和AX寄存器扩展称为32位寄存器，其中DX为高16位。扩展所用的指令为CWD，扩展字长一般用在乘法和除法当中。
- [ ] 对某些IO操作，DX可以用来存放IO端口地址。


###### 指针寄存器：BP 与 SP #####

现代CPU都有栈的设计，提供PUSH（入栈）和POP（出栈）指令。8086的入栈和出栈都是以字为单位进行的，字在这里即16位长度。

* BP（base pointer）基址指针寄存器
* SP（stack pointer）堆栈指针寄存器

这两个寄存器可以和堆栈段寄存器联用用来确定堆栈中的某一段存储单元的地址。其中SP用来指示栈顶的偏移地址，BP可以用来指示在堆栈中的偏移地址。

一般与堆栈段寄存器（SS）联用进行寻址：

```
SS:SP
```

SP（栈指针寄存器）和SS配合使用，确定栈顶元素地址。

8086CPU中，段寄存器SS负责存放栈顶的段地址，SP寄存器负责存放偏移地址。任意时刻，SS:SP指向栈顶元素。

注意，8086机中，栈在内存地址空间高位，向低位生长，所以PUSH指令会导致SP-2，POP指令导致SP+2。另外，8086CPU不保证对栈的操作不会越界的硬件保障。

```
PUSH 寄存器		;寄存器内容入栈
POP 寄存器		;栈顶元素写入寄存器
PUSH 内存单元
POP 内存单元
```

###### 变址寄存器：SI 与 DI #####

si和di是8086CPU中和bx功能相近的寄存器，si和di不能够分成两个8位寄存器使用。

* SI（source index register）源变址寄存器
* DI（destination index register）目的变址寄存器

这两个寄存器一般和数据段寄存器DS联用，用来确定数据段中某个存储单元的地址。这两个变址寄存器具有自增或者自减的功能，用来进行变址就非常方便。例如，可以用来对两个字符串进行复制。其中SI和DS进行联用，DI和ES进行联用。

下面例子中，idata代表数值。`()`代表对应内存单元的值。

**直接寻址**

[idata]

**寄存器间接寻址**

[bx]、[si]、[di]、[bp]

**寄存器相对寻址**

[bx+idata]、[si+idata]、[di+idata]、[bp+idata]

说明：[bx+idata]表示内存单元，其偏移地址为(bx)+idata，便于进行数组处理。

**基址变址寻址**

[bx+si]、[bx+di]、[bp+si]、[bp+di]

说明：[bx+si]和[bx+di]含义相似，均代表内存单元。以[bx+si]为例，其偏移地址位(bx)+(si)。

**相对基址变址寻址**

[bx+si+idata]、[bx+di+idata]、[bp+si+idata]、[bp+di+idata]

说明：[bx+si+idata]和[bx+di+idata]含义相似，均代表内存单元。以[bx+si+idata]为例，其偏移地址位(bx)+(si)+idata。

## 2 专用寄存器 ##

8086/8088中的专用寄存器是用来控制用的，或者是用来指示一些状态，包括IP指令指针寄存器，FLAGS标志寄存器。

###### 指令指针寄存器：IP #####

IP寄存器用来存放代码段（CS）中的偏移地址，在程序运行的过程中保存下一条指令的首地址。在程序的执行中起着非常重要的作用，例如可以用来控制程序的执行流程（选择语句，循环语句等），CPU会根据该寄存器中的值进行取址-执行。

IP（指令指针寄存器）和CS配合使用，确定需要执行代码的地址。

8086机中，任意时刻，CPU将CS:IP指向段内容当作指令执行。其工作流程为：

1. 从CS:IP指向段内存单元读取指令，读取的指令进入指令缓存器；
2. IP=IP+所读取指令的长度，从而指向下一条指令；
3. 执行指令。转到步骤1，重复这个过程。

注意，0xFFFF0单元中的指令是8086开机后执行的第一条指令。

注意，mov指令不能用于设置CS和IP的值，因为8086CPU并没有提供相应的功能。

**可以使用jmp指令修改CS和IP的值。**`jmp 段地址:便宜地址`用指令中给出的段地址修改CS，偏移地址修改IP。`jmp 某一合法寄存器`指令的功能为：用寄存器中的值修改IP。

###### 标志寄存器：PSW #####

* FLAGS标志寄存器（PSW）：标志寄存器对于不同的处理机，其个数和结构都可能不同。8086CPU的标志寄存器有16位，其中存储的信息通常被称为程序状态字。用来存放运算结果的标志（是否溢出，是否进位等），控制标志和系统标志的寄存器。

其中这些状态都有该寄存器中的特定的位进行表征。该寄存器各个位所代表的状态如下图所示：

![](https://raw.githubusercontent.com/yixy4app/images/picgo/202209022036962.png)

标志寄存器对于不同的处理机，其个数和结构都可能不同。8086CPU的标志寄存器有16位，其中存储的信息通常被称为程序状态字（PSW）。

* ZF：零标志位位，记录相关指令执行后，其结果是否为0。
* PF：奇偶标志位，记录相关指令执行后，其结果的所有bit位中1的个数是否为偶数。
* SF：符号标志位，记录相关指令执行后，其结果是否为负。
* CF：进位标志位，记录无符号运算后，其结果的最高有效位向更高位的进位值，或从更高位的借位值。
* OF：溢出标志位，记录有符号运算后，是否发生了溢出。
* DF：方向标志位，在串处理指令中，控制每次操作后si、di的增减。

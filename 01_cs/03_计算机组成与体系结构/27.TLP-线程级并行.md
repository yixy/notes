# TLP-线程级并行

**线程级并行（TLP，thread-level parallelism）意味着存在多个程序计数器，主要采用 MIMD架构。**

在计算机发展的早期，计算机每次只能运行一个进程（在操作系统(OS)中能拥有资源和独立运行基本单位）。但这一切在1967年迎来了变化，蓝色巨人IBM公司开发的**OS /360 操作系统，首次实现了多线程**(Multiprogamming with a Variable Number of Tasks) ，那时候还没有建立线程(Thread)的概念，他们称之为任务(Tasks)。但注意，那时计算机系统依旧不能同时处理多个线程。随着处理器技术的发展，英特尔和AMD也都意识到，当主频接近4GHz时，速度也会遇到自己的极限：那就是**单靠主频提升，已经无法明显提升系统整体性能**。因此迫切需要一个能支持同时处理2个线程以上的处理器，来提升CPU的瓶颈。需求推动了技术，线程级并行应运而生。

## 1 TLP与ILP的区别 ##

**ILP的并行性，是对外不可见的，对计算机体系结构的上层而言是透明的。**超标量处理器内部只有一个指令指针，一套控制逻辑，也就是说，对于外界而言，在同一时刻，只能执行一段指令序列。

**多核处理器解决的是线程之间并行（TLP）的问题，这种并行是对外可见的。**需要注意的是，现代处理器单个核心一般可以支持多线程执行，在多核处理器的实现中，各个核心是被看作独立的处理器，共享同一个内存，在同一时刻，不同的核心之间执行不同的指令序列（可以看到，PC、寄存器、控制逻辑都是独立的）。

线程级并行技术主要指：1）**同时多线程（SMT）/超线程（HT）**；2）**多核和多处理器。**

## 2 TLP技术：SMT/HT ##

* SMT（同时多线程Simultaneous multithreading）/HT（超线程技术，Hyper-Threading，简称HT。HT这个是Intel的叫法，本质上实际就是SMT）：是一种在一个CPU 的时钟周期内能够执行来自多个线程的指令的硬件多线程技术。本质上，同步多线程是一种将线程级并行处理（多CPU）转化为指令级并行处理（同一CPU）的方法。 SMT是在指令级并行的基础上的扩展，可以在一个核上运行多个线程，多个线程共享执行单元，以便提高部件的利用率，提高吞吐量。SMT需要为每个线程单独保持状态，如程序计数器（PC），寄存器堆，重排序缓冲等。

在超线程技术中，一个物理CPU核心被伪装成两个以上的逻辑CPU核心，看起来就像多个CPU在同时执行任务。这是通过在一个物理核心中创建多个线程实现的，每个线程都有自己的PC寄存器、指令寄存器和条件码寄存器。当线程A的指令停顿的时候，物理CPU核心的译码器和算术逻辑单元（ALU）就会空出来，这时线程B就可以运行自己的指令。这样就可以提高CPU的利用效率。需要注意的是，如果译码器和ALU也是双份的，那么这就是真正的多个CPU核心了，不能称为超线程技术。注意超线程技术与编程语言中的线程是不同层面上的两个东西。本文主要讲解的超线程技术是CPU硬件层面上的概念。而编程中的线程，是操作系统级别的概念，是软件层面上的概念。

## 3 TLP技术：SMP（Shared-Memory Multiprocessor）体系结构 ##

> 注意，不同语境下SMP术语的区分。

**共享存储器多处理器(Shared-Memory Multiprocessor)**：通过一个共享的地址空间进行通信和协调的多处理器系统，与之相对的概念是**集群(Cluster)**，后者每个节点都有独立的地址空间。

共享存储器多处理器的多处理器体系结构有两类：

![UMA](https://raw.githubusercontent.com/yixy4app/images/picgo/202208272135557.png)

* UMA(Uniform Memory Access)：又叫SMP(Symmetric Multiprocessor)，即对称共享存储器多处理器（集中共享存储器多处理器）。所有的处理器通过总线连接在一起，访问一个共享的存储器，每个节点的存储器访问延迟相同。目前常见的桌面多核处理器就是这种结构。

![NUMA](https://raw.githubusercontent.com/yixy4app/images/picgo/202208272137136.png)

* NUMA(Non-Uniform Memory Access)：又叫DSM（分布式共享存储器）处理器。采用分布式存储器，每个核心访问本地存储器时延迟较短，访问其他节点有不同的延迟。

在UMA和NUMA这两种体系结构中，线程之间的通信是通过共享地址空间完成的，也就是说，任何一个拥有正确寻址权限的处理器都可以向任意存储器位置发出存储器引用。与UMA和NUMA相关联的共享存储器一词是指共享地址空间这一事实。

共享存储器多处理器的具体实现方式有两类：

* CMP（多核心指单芯片多处理器，Chip multiprocessors，简称CMP）：是SMP的一种实现方式，在一个芯片内集成多个处理器。
* 多socket，多物理CPU


